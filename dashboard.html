<!DOCTYPE html>
<html lang="en">
<head>
    <title>OCT Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <!---NAV BAR --->
    <div class="nav-bar">
        <div class="nav-brand">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
            <h1>OSASCommsTracker</h1>
        </div>
        <div class="nav-menu">
            <a href="dashboard.html">Dashboard</a>
            <div class="datetime" id="datetime"></div>
        </div>
    </div>
    <!---SIDE BAR --->
    <div class="sidebar">
        <ul>
            <li><a href="addComms.html">Communications</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1cGctdRdN28EwrkSIaxh-ngAidtCU8QYuryrsN4Nji3Y/edit?usp=sharing" target="_blank">Sheets</a></li>
            <li><a href="#" class="logout-btn" onclick="showLogoutModal()">Logout</a></li>
        </ul>
    </div>

    <!--- DASHBOARD CONTENT --->
    <div class="main-content">
        <div class="container">
            <div class="dashboard-header">
                <h2>Dashboard</h2>
                <a href="addComms.html">
                    <button class="add-button">Add Record</button>
                </a>
            </div>
            <div class="search-form">
                <form id="searchForm">
                    <input type="text" name="searchTerm" placeholder="Search..." required>
                    <select name="sheetName">
                        <option value="Incoming">Incoming</option>
                        <option value="Outgoing">Outgoing</option>
                    </select>
                    <button type="submit">Search</button>
                </form>
            </div>
            <div class="results" id="results"></div>
        </div>
    </div>

    <!--- LOGOUT MODAL --->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to logout?</p>
            <div class="modal-buttons">
                <button class="modal-button confirm-btn" onclick="performLogout()">Yes</button>
                <button class="modal-button cancel-btn" onclick="hideLogoutModal()">No</button>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('sidebar-active');
        }
    
        function showLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }
    
        function hideLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }
    
        function performLogout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    
        function updateDateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            };
            const formattedDateTime = now.toLocaleString('en-US', options);
            document.getElementById('datetime').textContent = formattedDateTime;
        }
    
        updateDateTime();
        setInterval(updateDateTime, 1000);
    
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Loading...</div>';
    
            try {
                const formData = new FormData(this);
                const response = await fetch('https://script.google.com/macros/s/AKfycbwJ_xFb7N2EOJONodvETyFpyMTPwFVk-_lS4vMfXDTQpuFJL_WeUovZfg_bX-dADZPz/exec', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
            console.log('Full Response Data:', data);
            console.log('Received searchResults:', data.searchResults);

            if (data.searchResults && data.searchResults.length > 0) {
                let html = `<h3>${data.sheetName} Search Results</h3><table><thead><tr>`;
                const headers = data.searchResults[0];
                console.log('Extracted Headers:', headers);

                // Verify column count based on sheetName
                const expectedColumns = data.sheetName === "Incoming" ? 6 : 7;
                if (headers.length !== expectedColumns) {
                    console.warn(`Warning: Expected ${expectedColumns} columns for ${data.sheetName}, but got ${headers.length}`);
                }

                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += `</tr></thead><tbody>`;

                for (let i = 1; i < data.searchResults.length; i++) {
                    html += `<tr>`;
                    const row = data.searchResults[i];
                    console.log(`Row ${i} data:`, row);
                    if (row.length !== headers.length) {
                        console.warn(`Row ${i} has ${row.length} columns, expected ${headers.length}`);
                    }
                    headers.forEach((_, index) => {
                        html += `<td>${row[index] || ''}</td>`;
                    });
                    html += `</tr>`;
                }
                html += `</tbody></table>`;
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `<p class="no-results">No results found for "${data.searchTerm || 'your search'}"</p>`;
            }
        } catch (error) {
            console.error('Error:', error);
            resultsDiv.innerHTML = '<p class="no-results">An error occurred while fetching results</p>';
        }
    });
</script>

</body>
</html>